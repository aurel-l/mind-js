"use strict";var _slicedToArray=function(a,b){if(Array.isArray(a))return a;for(var c,d=[],e=a[Symbol.iterator]();!(c=e.next()).done&&(d.push(c.value),!b||d.length!==b););return d};!function(){var a=function(){var a=Math.random().toString(16)+Date.now().toString(16);return a.substring(2,a.length)},b={mm:localforage.createInstance({name:"mindmaps",storeName:"mindmaps"}),meta:localforage.createInstance({name:"metadata",storeName:"metadata"}),res:localforage.createInstance({name:"resources",storeName:"resources"})},c=void 0;b.res.keys().then(function(a){return c=new Set(a)});var d={resource:{get:function(a){return b.res.getItem(a)},set:function(d){for(var e=void 0===arguments[1]?{name:"untitled"}:arguments[1],f=null;!f||f in c;)f=e.name+"-"+a();return c.add(f),b.res.setItem(f,{content:d,meta:e}).then(function(){return f})}}};console.log(d);var e=function(a,b){return Date.parse(b.meta.date.changed)-Date.parse(a.meta.date.changed)},f={$schema:"http://json-schema.org/draft-04/schema#",description:"mindmap-schema",definitions:{node:{type:"object",properties:{title:{type:"string"},children:{type:"array",items:{$ref:"#/definitions/node"},uniqueItems:!0},content:{type:"object",properties:{data:{type:"string"},typeContent:{type:"string","enum":["text","image","video","url"]}}}},required:["title"]}},type:"object",properties:{name:{type:"string"},root:{$ref:"#/definitions/node"}},required:["name","root"]},g=new ZSchema,h=[];b.meta.iterate(function(a,b){h.push({key:b,meta:a})}).then(function(){h.sort(e),console.log("loaded all existing metadata")}),Polymer({list:h,load:function(a){var c=h.filter(function(b){return b.key===a}),d=_slicedToArray(c,1),e=d[0];return b.mm.getItem(a).then(function(b){if(!b)throw"Not an existing mindmap";return{key:a,meta:e.meta,data:b}})},create:function(b){var c=this;new Promise(function(c){for(var d=void 0;!d||h.some(function(a){return a.key===d});)d=a();var e=new Date;b?!function(){var a=new FileReader;a.readAsText(b),a.addEventListener("load",function(a){var b=JSON.parse(a.target.result),h=g.validate(f,b);if(!h)throw"invalid json file";c({key:d,meta:{name:b.name,date:{created:b.created||e.toISOString(),changed:b.changed||e.toISOString()}},data:b})})}():c({key:d,meta:{name:"new mindmap "+e.toLocaleString(),date:{created:e.toISOString(),changed:e.toISOString()}},data:{name:"new mindmap "+e.toLocaleString(),root:{title:"new mindmap "+e.toLocaleString(),children:[],parent:null,content:{data:"root node",typeContent:"text"}}}})}).then(function(a){console.log(a),h.unshift({key:a.key,meta:a.meta}),c.save(a)},console.error)},save:function(a){var c=h.filter(function(b){return b.key===a.key}),c=_slicedToArray(c,1),d=c[0];a.meta.date.changed=(new Date).toISOString(),h.sort(e),d.meta=a.meta,b.meta.setItem(a.key,a.meta),b.mm.setItem(a.key,a.data),console.log(h)},clear:function(a){if(a){var d,d;!function(){b.meta.removeItem(a),b.mm.removeItem(a),d=h.filter(function(b){return b.key===a}),d=_slicedToArray(d,1);var c=d[0];h.splice(h.indexOf(c),1)}()}else for(b.meta.clear(),b.mm.clear(),b.res.clear(),c.clear();h.length>0;)h.pop()}})}();